# Deploy Application to Azure Private Endpoints Environment

This document provides instructions for deploying the web application and database to the Azure environment with private endpoints.

## Prerequisites

1. Azure CLI installed and logged in
2. Access to the Azure subscription
3. Bicep infrastructure deployed successfully
4. Web application package (`lexdemo_202412261902.zip`)
5. Database backup file (`lexdemodb_2024_12_03-04-53.bacpac`)

## Important: Discriminator Parameter

> **ALL operations require a discriminator parameter** that uniquely identifies your environment. The discriminator is used in resource group naming and resource naming to enable multiple parallel deployments without naming conflicts.

- **What is a discriminator?** A short string (typically 4-5 characters) that identifies your environment (e.g., "lexsb", "lexwa", "prod", "dev")
- **Default value:** If not specified, most scripts use "lexsb" as the default discriminator
- **How to specify:** Pass it as the first parameter to scripts: `./script_name.sh myenv`
- **Naming pattern:** Resources follow the pattern `resource-type-{discriminator}-{purpose}` (e.g., `app-lexsb-ClientA`, `vnet-lexsb-central`)

If you're working with an existing environment, you must use the same discriminator that was used during its creation.

## Steps to Deploy

### 1. Database Deployment (Automated)

The database deployment is handled by the `deploy-app.sh` script. It:

1. Creates a new SQL database if it doesn't exist
2. Creates a temporary firewall rule to allow import
3. Uploads the bacpac file to the storage account
4. Imports the database from the bacpac file
5. Configures the connection string in the web app

Run the script with your discriminator:
```bash
./deploy-app.sh myenv
```

### 2. Web Application Deployment (Manual)

Due to private endpoint restrictions, the web application deployment must be done manually through the Azure Portal:

1. Web app package has been uploaded to storage: `stg{discriminator}clienta/artifacts/webapp_deploy.zip`
2. You can access it via the SAS URL generated by the script

Steps to deploy manually:

1. In the Azure Portal, navigate to the App Service
2. Go to "Deployment Center"
3. Choose "Manual Deployment" or "ZIP Deploy"
4. Upload the web app package from your local machine or use the URL from storage

Or use Azure CLI from a machine with access to the private endpoints:

```bash
az webapp deploy --resource-group rg-{discriminator}-ClientA --name app-{discriminator}-ClientA --src-path "webapp_deploy.zip" --type zip
```

### 3. Verify Deployment

1. Test the web application through Front Door:
   - URL: https://afd-ep-{discriminator}-ClientA-f0f6huhhecgtc9ep.z03.azurefd.net

2. Verify the database connection:
   - The web app should be able to connect to the database through private endpoints
   - The connection string has been configured to use: `sql-{discriminator}-ClientA.privatelink.database.windows.net`

3. Confirm access restrictions are working:
   - Direct access to the web app should be blocked (by design)
   - Access through Front Door should work

You can validate the deployment using the validation script with your discriminator:
```bash
./validate-deployment.sh myenv
```

## Outstanding Items

1. Implement CI/CD pipeline for automated deployment
2. Secure credential handling (use Key Vault instead of hardcoded values)
3. Setup proper release management process

## Troubleshooting

- If the web app deployment fails, check the access restrictions and network rules
- For database connection issues, verify the private DNS resolution is working
- Front Door may take some time to propagate the configuration changes

Always specify your discriminator when running scripts to ensure you're working with the correct resources:
```bash
./script_name.sh myenv
```